<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id={{ GOOGLE_ANALYTICS_ID }}"></script>
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-J4FCCY6G08"></script>

   <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());

        gtag('config', '{{ GOOGLE_ANALYTICS_ID }}');
    </script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Coze 邀请码分享系统 - 自动化获取和分享 Coze AI 平台邀请码的效率工具">
    <meta name="keywords" content="Coze, AI, 邀请码, 自动化, 管理系统">
    <meta name="author" content="dooleaf.cn">
    <meta property="og:title" content="Coze 邀请码分享系统">
    <meta property="og:description" content="高效的 Coze AI 平台邀请码自动化管理工具">
    <meta property="og:image" content="/static/og-image.png">
    <meta property="og:url" content="https://dooleaf.cn">
    <title>Coze 邀请码分享系统 - 由 dooleaf.cn 提供</title>
    <link rel="icon" type="image/ico" href="/static/favicon.ico">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/@mdi/font@7.2.96/css/materialdesignicons.min.css" rel="stylesheet">
    <style>
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .animate-spin {
            animation: spin 1s linear infinite;
        }
        .fade-enter-active, .fade-leave-active {
            transition: opacity 0.3s ease;
        }
        .fade-enter-from, .fade-leave-to {
            opacity: 0;
        }
        .notification {
            transition: all 0.3s ease;
        }
        .notification-enter-from, .notification-leave-to {
            transform: translateY(-20px);
            opacity: 0;
        }
        .step-enter-active, .step-leave-active {
            transition: all 0.3s ease;
        }
        .step-enter-from {
            opacity: 0;
            transform: translateX(30px);
        }
        .step-leave-to {
            opacity: 0;
            transform: translateX(-30px);
        }
        .gradient-text {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        .fade-in {
            animation: fadeIn 0.5s ease-in;
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        .copy-success {
            animation: fadeOut 2s forwards;
        }
        @keyframes fadeOut {
            0% { opacity: 1; }
            70% { opacity: 1; }
            100% { opacity: 0; }
        }
    </style>
</head>
<body class="bg-gray-50">
    <div id="app">
        <!-- Header -->
        <header class="bg-white shadow-sm fixed w-full top-0 z-50">
            <nav class="container mx-auto px-4 py-4">
                <div class="flex justify-between items-center">
                    <div class="flex items-center space-x-4">
                        <a href="/" class="flex items-center space-x-2">
                            <img src="/static/logo.webp" alt="Logo" class="h-8 w-8">
                            <span class="font-bold text-xl gradient-text">Coze 邀请码</span>
                        </a>
                    </div>
                    <div class="flex items-center space-x-6">
                        <a href="#features" class="text-gray-600 hover:text-gray-900">功能特点</a>
                        <a href="https://dooleaf.cn" target="_blank" class="text-gray-600 hover:text-gray-900">关于我们</a>
                        <div class="flex items-center space-x-2 text-sm">
                            <span class="mdi" :class="isUpdating ? 'mdi-sync animate-spin text-blue-500' : 'mdi-clock-outline text-gray-600'"></span>
                            <span class="text-gray-600">
                                {{ isUpdating ? '正在更新...' : countdown }}
                            </span>
                        </div>
                    </div>
                </div>
            </nav>
        </header>

        <!-- Hero Section -->
        <section class="pt-24 pb-12 bg-gradient-to-b from-white to-gray-50">
            <div class="container mx-auto px-4">
                <div class="max-w-4xl mx-auto text-center">
                    <h1 class="text-4xl md:text-5xl font-bold mb-6 gradient-text">
                        分享 Coze AI 邀请码
                    </h1>
                    <p class="text-xl text-gray-600 mb-8">
                        自动化获取、实时更新、智能分享，让您的 Coze AI 邀请码分享更轻松
                    </p>
                    <div class="flex justify-center space-x-4">
                        <div class="bg-white rounded-lg shadow-lg p-4 text-center">
                            <div class="text-2xl font-bold text-blue-600 mb-2">{{ inviteCodes.length }}</div>
                            <div class="text-gray-600">可用邀请码</div>
                        </div>
                        <div class="bg-white rounded-lg shadow-lg p-4 text-center">
                            <div class="text-2xl font-bold text-green-600 mb-2">
                                {{ inviteCodes.filter(code => code.status === '未激活').length }}
                            </div>
                            <div class="text-gray-600">未使用</div>
                        </div>
                        <div class="bg-white rounded-lg shadow-lg p-4 text-center">
                            <div class="text-2xl font-bold text-purple-600 mb-2">
                                {{ inviteCodes.filter(code => code.status === '已激活').length }}
                            </div>
                            <div class="text-gray-600">已使用</div>
                        </div>
                    </div>
                </div>
            </div>
        </section>
<!-- Main Content -->
<main class="container mx-auto px-4 py-8 mt-8">
    <!-- 原有的通知组件 -->
    <Transition name="notification">
        <div v-if="notification.show" 
             class="fixed top-4 right-4 p-4 rounded-lg shadow-lg text-white flex items-center space-x-2"
             :class="notification.type === 'success' ? 'bg-green-500' : 'bg-red-500'">
            <span class="mdi" :class="notification.type === 'success' ? 'mdi-check-circle' : 'mdi-alert-circle'"></span>
            <span>{{ notification.message }}</span>
        </div>
    </Transition>

    <div class="bg-white rounded-lg shadow-lg p-6 mb-8">
        <!-- 添加刷新按钮 -->
        
        <!-- 原有的更新状态和错误信息显示 -->
        <Transition name="step">
            <div v-if="isUpdating" class="mb-6 bg-blue-50 border border-blue-200 rounded-lg p-4">
                <div class="flex items-center space-x-3">
                    <span class="mdi mdi-loading animate-spin text-blue-500 text-xl"></span>
                    <div class="flex-1">
                        <h3 class="font-medium text-blue-700">系统正在更新数据</h3>
                        <p class="text-blue-600">{{ currentStep || '准备中...' }}</p>
                    </div>
                </div>
            </div>
        </Transition>

        <Transition name="step">
            <div v-if="lastError" class="mb-6 bg-red-50 border border-red-200 rounded-lg p-4">
                <div class="flex items-center space-x-3">
                    <span class="mdi mdi-alert text-red-500 text-xl"></span>
                    <div class="flex-1">
                        <h3 class="font-medium text-red-700">更新过程中出现错误</h3>
                        <p class="text-red-600">{{ lastError }}</p>
                    </div>
                </div>
            </div>
        </Transition>

        <!-- 原有的邀请码卡片网格 -->
        <div id="codes" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
            <div v-for="code in inviteCodes" :key="code.code" 
                 class="border rounded-lg p-4 transition-all duration-300 hover:shadow-md transform hover:-translate-y-1"
                 :class="{'bg-green-50 border-green-200': code.status === '未激活',
                         'bg-gray-50 border-gray-200': code.status === '已激活'}">
                <div class="flex justify-between items-center mb-2">
                    <span class="text-lg font-semibold" :class="{'text-green-600': code.status === '未激活'}">
                        {{ code.code === randomUnactivatedCode ? code.code : '********' }}
                    </span>
                    <span class="text-sm px-2 py-1 rounded"
                          :class="{'bg-green-100 text-green-700': code.status === '未激活',
                                  'bg-gray-100 text-gray-700': code.status === '已激活'}">
                        {{ code.status }}
                    </span>
                </div>
                <button @click="copyCode(code.code)" 
                        class="w-full mt-2 bg-gray-100 hover:bg-gray-200 text-gray-700 px-4 py-2 rounded flex items-center justify-center transition-colors duration-300"
                        :disabled="code.code !== randomUnactivatedCode">
                    <span class="mdi mdi-content-copy mr-2"></span>
                    {{ code.code === randomUnactivatedCode ? '复制邀请码' : '已隐藏' }}
                </button>
            </div>
        </div>

        <div v-if="!inviteCodes || inviteCodes.length === 0" class="text-center py-8">
            <span class="mdi mdi-alert text-4xl text-gray-400"></span>
            <p class="text-gray-500 mt-2">暂无可用的邀请码</p>
        </div>
    </div>
</main>

<!-- 原有的更新时间信息 -->
<div class="text-center text-gray-500 text-sm space-y-1">
    <p>系统每 10 分钟自动更新一次数据</p>
    <p>最后更新时间：{{ formatDateTime(lastUpdateTime) || '暂无更新' }}</p>
</div>

        <!-- Features Section -->
        <section id="features" class="py-12 bg-white">
            <div class="container mx-auto px-4">
                <h2 class="text-3xl font-bold text-center mb-12 gradient-text">功能特点</h2>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-8 max-w-5xl mx-auto">
                    <div class="text-center p-6">
                        <span class="mdi mdi-refresh text-4xl text-blue-500"></span>
                        <h3 class="text-xl font-semibold my-4">自动更新</h3>
                        <p class="text-gray-600">每10-15分钟自动获取最新邀请码，无需手动操作</p>
                    </div>
                    <div class="text-center p-6">
                        <span class="mdi mdi-clock-fast text-4xl text-green-500"></span>
                        <h3 class="text-xl font-semibold my-4">实时状态</h3>
                        <p class="text-gray-600">实时显示邀请码状态，快速区分可用与已用</p>
                    </div>
                    <div class="text-center p-6">
                        <span class="mdi mdi-shield-check text-4xl text-purple-500"></span>
                        <h3 class="text-xl font-semibold my-4">安全可靠</h3>
                        <p class="text-gray-600">数据本地存储，确保信息安全</p>
                    </div>
                </div>
            </div>
        </section>

        
        
        <!-- Footer -->
        <footer class="mt-12 pb-8">
            <div class="max-w-4xl mx-auto px-4">
                <div class="border-t pt-8">
                    <!-- 技术栈说明 -->
                    <div class="mb-6">
                        <h3 class="text-lg font-semibold text-gray-700 mb-3">技术实现</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm text-gray-600">
                            <div>
                                <h4 class="font-medium mb-2">后端技术：</h4>
                                <ul class="list-disc list-inside space-y-1">
                                    <li>FastAPI 框架</li>
                                    <li>Selenium 自动化</li>
                                    <li>Schedule 定时任务</li>
                                    <li>Docker 容器化部署</li>
                                </ul>
                            </div>
                            <div>
                                <h4 class="font-medium mb-2">前端技术：</h4>
                                <ul class="list-disc list-inside space-y-1">
                                    <li>Vue.js 3 响应式框架</li>
                                    <li>Tailwind CSS 样式框架</li>
                                    <li>Material Design Icons 图标</li>
                                    <li>LocalStorage 本地存储</li>
                                </ul>
                            </div>
                        </div>
                    </div>

                    <!-- 开发步骤 -->
                    <div class="mb-6">
                        <h3 class="text-lg font-semibold text-gray-700 mb-3">开发步骤</h3>
                        <ol class="list-decimal list-inside space-y-2 text-sm text-gray-600">
                            <li>设计并实现自动化登录和数据获取逻辑</li>
                            <li>开发后端 API 接口和定时更新机制</li>
                            <li>构建响应式前端界面和实时更新功能</li>
                            <li>实现邀请码状态管理和本地存储</li>
                            <li>添加错误处理和用户反馈机制</li>
                            <li>优化界面交互和用户体验</li>
                            <li>配置 Docker 容器化部署环境</li>
                        </ol>
                    </div>

                    <!-- 版权信息 -->
                    <div class="text-center text-sm text-gray-500 space-y-2">
                        <p>© {{ new Date().getFullYear() }} <a href="https://dooleaf.cn" target="_blank" class="text-blue-500 hover:text-blue-600">dooleaf.cn</a> 版权所有</p>
                        <p class="text-xs">本项目使用 Claude + Cursor 智能编程助手开发</p>
                    </div>
                </div>
            </div>
        </footer>
    </div>

    <script>
        const { createApp } = Vue

        createApp({
            data() {
                return {
                    inviteCodes: [],
                    isUpdating: false,
                    currentStep: null,
                    lastUpdateTime: null,
                    nextUpdateTime: null,
                    lastError: null,
                    countdown: '',
                    countdownInterval: null,
                    notification: {
                        show: false,
                        type: 'success',
                        message: ''
                    },
                    randomUnactivatedCode: null,
                    retryCount: 0,
                    maxRetries: 3,
                    pollingInterval: null,
                    lastFetchTime: 0
                }
            },
            methods: {
                showNotification(message, type = 'success') {
                    this.notification = {
                        show: true,
                        type,
                        message
                    }
                    setTimeout(() => {
                        this.notification.show = false
                    }, 3000)
                },
                formatDateTime(isoString) {
                    if (!isoString) return null;
                    const date = new Date(isoString);
                    return date.toLocaleString('zh-CN', {
                        year: 'numeric',
                        month: '2-digit',
                        day: '2-digit',
                        hour: '2-digit',
                        minute: '2-digit',
                        second: '2-digit',
                        hour12: false
                    });
                },
                updateCountdown() {
                    if (!this.nextUpdateTime) {
                        this.countdown = '等待下次更新...';
                        return;
                    }

                    const now = Date.now();
                    const diff = this.nextUpdateTime - now;

                    if (diff <= 0) {
                        this.countdown = '即将更新...';
                        return;
                    }

                    const minutes = Math.floor(diff / 60000);
                    const seconds = Math.floor((diff % 60000) / 1000);
                    this.countdown = `${minutes}分${seconds}秒后更新`;
                },
                sortCodes(codes) {
                    return [...codes].sort((a, b) => {
                        // 将随机选中的未激活码排在最前面
                        if (a.code === this.randomUnactivatedCode) return -1;
                        if (b.code === this.randomUnactivatedCode) return 1;
                        
                        // 然后按激活状态排序
                        if (a.status === '未激活' && b.status !== '未激活') return -1;
                        if (a.status !== '未激活' && b.status === '未激活') return 1;
                        
                        // 最后按来源排序
                        if (a.source < b.source) return -1;
                        if (a.source > b.source) return 1;
                        
                        return 0;
                    });
                },
                async fetchData(force = false) {
                    const now = Date.now()
                    if (!force && now - this.lastFetchTime < 30000) {
                        return
                    }
                    
                    try {
                        this.lastFetchTime = now
                        const response = await fetch('/api/invite_codes')
                        const data = await response.json()
                        
                        this.isUpdating = data.is_updating
                        this.currentStep = data.current_step
                        this.lastUpdateTime = data.last_update_time
                        this.nextUpdateTime = data.next_update_time
                        this.lastError = data.last_error
                        
                        if (this.isUpdating) {
                            setTimeout(() => this.fetchData(true), 30000)
                            return
                        }
                        
                        if (!data.codes || !Array.isArray(data.codes)) {
                            console.warn('未获取到邀请码数据，保持现有状态')
                            return
                        }
                        
                        const copiedCodes = this.getCopiedCodes()
                        const processedCodes = data.codes.map(code => ({
                            ...code,
                            status: copiedCodes.includes(code.code) ? '已激活' : code.status
                        }))
                        
                        if (this.randomUnactivatedCode === null) {
                            const unactivatedCodes = processedCodes.filter(code => code.status === '未激活')
                            if (unactivatedCodes.length > 0) {
                                const randomIndex = Math.floor(Math.random() * unactivatedCodes.length)
                                this.randomUnactivatedCode = unactivatedCodes[randomIndex].code
                                this.retryCount = 0
                            }
                        }
                        
                        this.inviteCodes = this.sortCodes(processedCodes)
                        
                        const selectedCode = this.inviteCodes.find(code => code.code === this.randomUnactivatedCode)
                        if (!selectedCode || selectedCode.status !== '未激活') {
                            this.randomUnactivatedCode = null
                        }
                        
                        this.updatePollingInterval()
                        
                    } catch (error) {
                        console.error('Error fetching data:', error)
                        if (this.retryCount < this.maxRetries) {
                            this.retryCount++
                            setTimeout(() => this.fetchData(true), 2000)
                        } else {
                            this.showNotification('获取数据失败，请手动刷新重试', 'error')
                        }
                    }
                },
                updatePollingInterval() {
                    if (this.pollingInterval) {
                        clearInterval(this.pollingInterval)
                    }
                    
                    const now = Date.now()
                    const nextUpdate = this.nextUpdateTime ? new Date(this.nextUpdateTime).getTime() : now + 600000
                    const timeUntilNextUpdate = Math.max(30000, nextUpdate - now)
                    
                    this.pollingInterval = setTimeout(() => {
                        this.fetchData(true)
                    }, timeUntilNextUpdate)
                },
                copyCode(code) {
                    navigator.clipboard.writeText(code)
                        .then(() => {
                            this.showNotification('邀请码已复制到剪贴板')
                            const index = this.inviteCodes.findIndex(item => item.code === code)
                            if (index !== -1) {
                                this.inviteCodes[index].status = '已激活'
                                this.saveCopiedCode(code)
                            }
                        })
                        .catch(() => this.showNotification('复制失败，请手动复制', 'error'))
                },
                saveCopiedCode(code) {
                    const copiedCodes = this.getCopiedCodes()
                    if (!copiedCodes.includes(code)) {
                        copiedCodes.push(code)
                        localStorage.setItem('copiedCodes', JSON.stringify(copiedCodes))
                    }
                },
                getCopiedCodes() {
                    try {
                        return JSON.parse(localStorage.getItem('copiedCodes')) || []
                    } catch {
                        return []
                    }
                },
                startDataPolling() {
                    this.fetchData(true)
                    this.countdownInterval = setInterval(this.updateCountdown, 1000)
                },
                refreshPage() {
                    this.randomUnactivatedCode = null
                    this.retryCount = 0
                    this.fetchData(true)
                    this.showNotification('正在重新获取邀请码...')
                },
                beforeUnmount() {
                    if (this.countdownInterval) {
                        clearInterval(this.countdownInterval)
                    }
                    if (this.pollingInterval) {
                        clearInterval(this.pollingInterval)
                    }
                }
            },
            mounted() {
                this.fetchData()
                this.startDataPolling()
            },
            beforeUnmount() {
                this.beforeUnmount()
            }
        }).mount('#app')
    </script>
</body>
</html> 